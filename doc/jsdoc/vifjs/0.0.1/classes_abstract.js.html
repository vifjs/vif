<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/abstract.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/abstract.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
    TODO -> explain
*/

import { observerDispatch } from "../features/observe.js";
import { immutableChildrenOf } from "../utils/shortcuts.js";
import { isDefined } from "../utils/tests.js";
import { VIF } from "../utils/types.js";

export const xAbstract = {
    setup(datas) {
        let self = this;

        /**
         * immutableChildren can be used instead of template for hydration
         * @type {NodeList}
         */
        // self.immutableChildren = [];

        /**
         * immutableSchema can be used instead of creating schema
         * @type {VIF.Schema}
         */
        // self.immutableSchema = [];

        /**
         * datas is used as a context for the render function
         * @type {VIF.Element.Datas}
         */
        self.datas || (self.datas = datas || {});

        /**
         * every time a directive run, we store the reactive function
         * inside dependencies at this.trail, theses dependencies can be
         * used to unhydrate a component or a sub set of elements
         * @type {VIF.Dependencies.Trail}
         */
        self.trail || (self.trail = new Set());
    },

    /** @type {VIF.Element.DisconnectCallback} */
    disconnectCallback() {
        this.unHydrate();
    },

    /**
     * Hydrate HTMLElements based on schema
     * @param {NodeList} nodeList
     * @param {VIF.Schema} schema
     * @param {VIF.Dependencies.Trail} trail
     */
    hydrate(nodeList, schema, trail) {
        let self = this;

        /** @type {number} */
        let index = schema.length - 1;

        /**
         * we need immutableTrail as a duplicate of trail because changing trail
         * inside the while loop will influence sibling elements as a side effect
         * @type {VIF.Dependencies.Trail}
         */
        let immutableTrail = trail;

        // we play the schema in reverse order because the nodeList
        // can change during the hydration process by adding or removing
        // elements at the current index, so next indexes could change
        // for that reason we must use previous indexes
        while (index >= 0) {
            /** @type {VIF.Definition} */
            const definition = schema[index];

            /**
             * retrieve the HTMLElement from the index
             * @type {HTMLElement}
             */
            const element = nodeList[definition.pos];

            if (definition.reactive) {
                // we pass the current schema as immutableSchema
                // avoiding the creation of a new schema and it's performance cost
                element.immutableSchema = definition.schema;

                // we add the current element into the component trail
                (trail || self.trail).add(element);

                // dispatch the element tagName to the observer
                observerDispatch &amp;&amp; observerDispatch(element.tagName);
            }

            if (!trail) {
                /**
                 * loop over all hydratable attributes
                 * @type {Array&lt;string, VIF.Action>}
                 */
                for (const [name, action] of definition.attrs) {
                    // apply the corresponding directive
                    /** @type {VIF.Reactive|undefined} */
                    const reactiveFunction = action.directive(
                        self.datas,
                        element,
                        action.expression,
                        name
                    );

                    // push the reactiveFunction into component trail
                    // only if the directive return a reactive function
                    if (reactiveFunction) {
                        self.trail.add(reactiveFunction);
                    }
                }
            }

            if (definition.schema) {
                // check if the element is hydratable and update the trail at same time
                // trail should be updated only if the element is reactive
                const ishydratable =
                    !definition.reactive ||
                    (immutableTrail =
                        !isDefined(element) &amp;&amp; (element.trail = new Set()));

                // if the element is not a Vif component we hydrate children
                if (ishydratable) {
                    self.hydrate(
                        immutableChildrenOf(element),
                        definition.schema,
                        immutableTrail
                    );
                }
            }

            index--;
        }
    },

    /**
     * UnHydrate HTMLElements based on trail
     * @param {VIF.Dependencies.Reactives} trail
     */
    unHydrate() {
        /** @type {VIF.Reactive|VIF.Element} */
        for (const reactive of this.trail) {
            // prevent errors on custom reactives functions and non-defined xElements
            reactive.disconnectCallback &amp;&amp; reactive.disconnectCallback();
        }
        // clear the trail dependencies
        this.trail.clear();
    },
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="xHandler.html">xHandler</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Vif">Vif</a></li><li><a href="global.html#attributeDirective">attributeDirective</a></li><li><a href="global.html#createCssSelector">createCssSelector</a></li><li><a href="global.html#createCssTemplateOrSelector">createCssTemplateOrSelector</a></li><li><a href="global.html#createEmptyTemplate">createEmptyTemplate</a></li><li><a href="global.html#createFlag">createFlag</a></li><li><a href="global.html#createLiteralTemplate">createLiteralTemplate</a></li><li><a href="global.html#createPart">createPart</a></li><li><a href="global.html#createReferenceArray">createReferenceArray</a></li><li><a href="global.html#createTemplateFragmentFromNodeList">createTemplateFragmentFromNodeList</a></li><li><a href="global.html#createTemplateFragmentFromString">createTemplateFragmentFromString</a></li><li><a href="global.html#createTemplateSchema">createTemplateSchema</a></li><li><a href="global.html#cssDirective">cssDirective</a></li><li><a href="global.html#cssNextId">cssNextId</a></li><li><a href="global.html#currentReactive">currentReactive</a></li><li><a href="global.html#dataDirective">dataDirective</a></li><li><a href="global.html#defaultDirective">defaultDirective</a></li><li><a href="global.html#define">define</a></li><li><a href="global.html#defineMemo">defineMemo</a></li><li><a href="global.html#disconnectReactive">disconnectReactive</a></li><li><a href="global.html#evaluatorMemo">evaluatorMemo</a></li><li><a href="global.html#eventDirective">eventDirective</a></li><li><a href="global.html#generateFunctionFromString">generateFunctionFromString</a></li><li><a href="global.html#i18n">i18n</a></li><li><a href="global.html#i18nMemo">i18nMemo</a></li><li><a href="global.html#i18nOnLoad">i18nOnLoad</a></li><li><a href="global.html#isDefined">isDefined</a></li><li><a href="global.html#isXAttribute">isXAttribute</a></li><li><a href="global.html#isXElement">isXElement</a></li><li><a href="global.html#isXEventAttribute">isXEventAttribute</a></li><li><a href="global.html#isXTemplate">isXTemplate</a></li><li><a href="global.html#locale">locale</a></li><li><a href="global.html#locales">locales</a></li><li><a href="global.html#navigate">navigate</a></li><li><a href="global.html#observe">observe</a></li><li><a href="global.html#observerDispacther">observerDispacther</a></li><li><a href="global.html#observerMemo">observerMemo</a></li><li><a href="global.html#reactive">reactive</a></li><li><a href="global.html#reconcile">reconcile</a></li><li><a href="global.html#refDirective">refDirective</a></li><li><a href="global.html#removePart">removePart</a></li><li><a href="global.html#showDirective">showDirective</a></li><li><a href="global.html#signal">signal</a></li><li><a href="global.html#templateDirective">templateDirective</a></li><li><a href="global.html#textDirective">textDirective</a></li><li><a href="global.html#translations">translations</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Jan 19 2024 17:30:54 GMT+0100 (heure normale dâ€™Europe centrale)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
